{"version":3,"names":["runPodInstall","loader","shouldHandleRepoUpdate","start","chalk","dim","execa","error","stderr","stdout","includes","runPodUpdate","fail","logger","CLIError","link","docs","guide","log","underline","installCocoaPodsWithGem","options","_error","runSudo","join","installCocoaPods","stop","succeed","installPods","NoopLoader","fs","existsSync","process","chdir","hasPods","skipBundleInstall","runBundleInstall","e","info"],"sources":["../../src/tools/installPods.ts"],"sourcesContent":["import fs from 'fs';\nimport execa from 'execa';\nimport type {Ora} from 'ora';\nimport chalk from 'chalk';\nimport {\n  logger,\n  NoopLoader,\n  link,\n  CLIError,\n  runSudo,\n} from '@react-native-community/cli-tools';\nimport runBundleInstall from './runBundleInstall';\n\ninterface PodInstallOptions {\n  skipBundleInstall?: boolean;\n}\n\nasync function runPodInstall(\n  loader: Ora,\n  shouldHandleRepoUpdate: boolean = true,\n) {\n  try {\n    loader.start(\n      `Installing CocoaPods dependencies ${chalk.dim(\n        '(this may take a few minutes)',\n      )}`,\n    );\n\n    await execa('bundle', ['exec', 'pod', 'install']);\n  } catch (error) {\n    // \"pod\" command outputs errors to stdout (at least some of them)\n    const stderr = (error as any).stderr || (error as any).stdout;\n\n    /**\n     * If CocoaPods failed due to repo being out of date, it will\n     * include the update command in the error message.\n     *\n     * `shouldHandleRepoUpdate` will be set to `false` to\n     * prevent infinite loop (unlikely scenario)\n     */\n    if (stderr.includes('pod repo update') && shouldHandleRepoUpdate) {\n      await runPodUpdate(loader);\n      await runPodInstall(loader, false);\n    } else {\n      loader.fail();\n      logger.error(stderr);\n\n      throw new CLIError(\n        `Looks like your iOS environment is not properly set. Please go to ${link.docs(\n          'environment-setup',\n          'ios',\n          {guide: 'native'},\n        )} and follow the React Native CLI QuickStart guide for macOS and iOS.`,\n      );\n    }\n  }\n}\n\nasync function runPodUpdate(loader: Ora) {\n  try {\n    loader.start(\n      `Updating CocoaPods repositories ${chalk.dim(\n        '(this may take a few minutes)',\n      )}`,\n    );\n    await execa('pod', ['repo', 'update']);\n  } catch (error) {\n    // \"pod\" command outputs errors to stdout (at least some of them)\n    logger.log((error as any).stderr || (error as any).stdout);\n    loader.fail();\n\n    throw new CLIError(\n      `Failed to update CocoaPods repositories for iOS project.\\nPlease try again manually: \"pod repo update\".\\nCocoaPods documentation: ${chalk.dim.underline(\n        'https://cocoapods.org/',\n      )}`,\n    );\n  }\n}\n\nasync function installCocoaPodsWithGem() {\n  const options = ['install', 'cocoapods', '--no-document'];\n\n  try {\n    // First attempt to install `cocoapods`\n    await execa('gem', options);\n  } catch (_error) {\n    // If that doesn't work then try with sudo\n    await runSudo(`gem ${options.join(' ')}`);\n  }\n}\n\nasync function installCocoaPods(loader: Ora) {\n  loader.stop();\n\n  loader.start('Installing CocoaPods');\n\n  try {\n    await installCocoaPodsWithGem();\n\n    return loader.succeed();\n  } catch (error) {\n    loader.fail();\n    logger.error((error as any).stderr);\n\n    throw new CLIError(\n      `An error occured while trying to install CocoaPods, which is required by this template.\\nPlease try again manually: sudo gem install cocoapods.\\nCocoaPods documentation: ${chalk.dim.underline(\n        'https://cocoapods.org/',\n      )}`,\n    );\n  }\n}\n\nasync function installPods(loader?: Ora, options?: PodInstallOptions) {\n  loader = loader || new NoopLoader();\n  try {\n    if (!fs.existsSync('ios')) {\n      return;\n    }\n\n    process.chdir('ios');\n\n    const hasPods = fs.existsSync('Podfile');\n\n    if (!hasPods) {\n      return;\n    }\n\n    if (fs.existsSync('../Gemfile') && !options?.skipBundleInstall) {\n      await runBundleInstall(loader);\n    }\n\n    try {\n      // Check if \"pod\" is available and usable. It happens that there are\n      // multiple versions of \"pod\" command and even though it's there, it exits\n      // with a failure\n      await execa('pod', ['--version']);\n    } catch (e) {\n      loader.info();\n      await installCocoaPods(loader);\n    }\n\n    await runPodInstall(loader);\n  } finally {\n    process.chdir('..');\n  }\n}\n\nexport {installCocoaPods};\n\nexport default installPods;\n"],"mappings":"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"}