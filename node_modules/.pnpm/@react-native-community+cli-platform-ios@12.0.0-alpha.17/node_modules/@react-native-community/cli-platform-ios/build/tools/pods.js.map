{"version":3,"names":["getPackageJson","root","require","path","join","CLIError","getIosDependencies","dependencies","Object","keys","filter","dependency","platforms","ios","map","version","sort","dependenciesToString","generateMd5Hash","text","createHash","update","digest","compareMd5Hashes","hash1","hash2","resolvePods","nativeDependencies","options","packageJson","podfilePath","findPodfilePath","iosFolderPath","slice","lastIndexOf","podsPath","arePodsInstalled","fs","existsSync","iosDependencies","dependenciesString","currentDependenciesHash","cachedDependenciesHash","cacheManager","get","name","forceInstall","loader","getLoader","installPods","skipBundleInstall","set","succeed","fail","chalk","bold"],"sources":["../../src/tools/pods.ts"],"sourcesContent":["import path from 'path';\nimport fs from 'fs-extra';\nimport {createHash} from 'crypto';\nimport chalk from 'chalk';\nimport {\n  CLIError,\n  cacheManager,\n  getLoader,\n} from '@react-native-community/cli-tools';\nimport installPods from './installPods';\nimport findPodfilePath from '../config/findPodfilePath';\nimport {\n  DependencyConfig,\n  IOSDependencyConfig,\n} from '@react-native-community/cli-types';\n\ninterface ResolvePodsOptions {\n  forceInstall?: boolean;\n}\n\ninterface NativeDependencies {\n  [key: string]: DependencyConfig;\n}\n\nexport function getPackageJson(root: string) {\n  try {\n    return require(path.join(root, 'package.json'));\n  } catch {\n    throw new CLIError(\n      'No package.json found. Please make sure the file exists in the current folder.',\n    );\n  }\n}\n\nexport function getIosDependencies(dependencies: NativeDependencies) {\n  return Object.keys(dependencies)\n    .filter((dependency) => dependencies[dependency].platforms.ios)\n    .map(\n      (dependency) =>\n        `${dependency}@${\n          (dependencies[dependency].platforms.ios as IOSDependencyConfig)\n            .version\n        }`,\n    )\n    .sort();\n}\n\nexport function dependenciesToString(dependencies: string[]) {\n  return dependencies.join('\\n');\n}\n\nexport function generateMd5Hash(text: string) {\n  return createHash('md5').update(text).digest('hex');\n}\n\nexport function compareMd5Hashes(hash1: string, hash2: string) {\n  return hash1 === hash2;\n}\n\nexport default async function resolvePods(\n  root: string,\n  nativeDependencies: NativeDependencies,\n  options?: ResolvePodsOptions,\n) {\n  const packageJson = getPackageJson(root);\n  const podfilePath = findPodfilePath(root);\n  const iosFolderPath = podfilePath\n    ? podfilePath.slice(0, podfilePath.lastIndexOf('/'))\n    : path.join(root, 'ios');\n  const podsPath = path.join(iosFolderPath, 'Pods');\n  const arePodsInstalled = fs.existsSync(podsPath);\n  const iosDependencies = getIosDependencies(nativeDependencies);\n  const dependenciesString = dependenciesToString(iosDependencies);\n  const currentDependenciesHash = generateMd5Hash(dependenciesString);\n  const cachedDependenciesHash = cacheManager.get(\n    packageJson.name,\n    'dependencies',\n  );\n\n  if (\n    !cachedDependenciesHash ||\n    !compareMd5Hashes(currentDependenciesHash, cachedDependenciesHash) ||\n    !arePodsInstalled ||\n    options?.forceInstall\n  ) {\n    const loader = getLoader('Installing CocoaPods...');\n    try {\n      await installPods(loader, {skipBundleInstall: !!cachedDependenciesHash});\n      cacheManager.set(\n        packageJson.name,\n        'dependencies',\n        currentDependenciesHash,\n      );\n      loader.succeed();\n    } catch {\n      loader.fail();\n      throw new CLIError(\n        `Something when wrong while installing CocoaPods. Please run ${chalk.bold(\n          'pod install',\n        )} manually`,\n      );\n    }\n  }\n}\n"],"mappings":"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"}